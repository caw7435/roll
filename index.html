<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è‰è“åœ’å¹¸é‹è½‰ç›¤</title>
    <style>
      body {
        font-family: "Microsoft JhengHei", sans-serif;
        background-color: #fff0f5; /* æ·¡ç²‰è‰²èƒŒæ™¯ */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
      }

      h1 {
        color: #d32f2f;
        margin-bottom: 10px;
      }

      .game-container {
        position: relative;
        width: 300px;
        height: 300px;
        margin-bottom: 20px;
      }

      canvas {
        width: 100%;
        height: 100%;
        border-radius: 50%;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1);
      }

      .pointer {
        position: absolute;
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        width: 0;
        height: 0;
        border-left: 15px solid transparent;
        border-right: 15px solid transparent;
        border-top: 30px solid #d32f2f;
        z-index: 10;
      }

      .controls {
        background: white;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      input {
        padding: 10px;
        border: 2px solid #ffb6c1;
        border-radius: 5px;
        font-size: 16px;
        width: 200px;
        text-align: center;
        outline: none;
      }

      button {
        margin-top: 10px;
        padding: 10px 20px;
        background-color: #d32f2f;
        color: white;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        cursor: pointer;
        transition: background 0.3s;
      }

      button:hover {
        background-color: #b71c1c;
      }

      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      #result {
        margin-top: 15px;
        font-weight: bold;
        font-size: 18px;
        color: #333;
        min-height: 24px;
      }

      .note {
        margin-top: 10px;
        font-size: 12px;
        color: #666;
      }
    </style>
  </head>
  <body>
    <h1>ğŸ“ è‰è“å¹¸é‹è½‰ç›¤</h1>

    <div class="game-container">
      <div class="pointer"></div>
      <canvas id="wheelCanvas" width="500" height="500"></canvas>
    </div>

    <div class="controls">
      <input type="text" id="couponCode" placeholder="è«‹è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼" />
      <br />
      <button id="spinBtn" onclick="startGame()">é–‹å§‹æŠ½ç</button>
      <div id="result"></div>
      <div class="note">
        ä¸€ç:è‰è“ä¸€ç›’ã€äºŒç:è‰è“å‡ä¹¾ã€ä¸‰ç:å†°æ·‡æ·‹ã€æ™®ç:æŠ˜åƒ¹åˆ¸
      </div>
    </div>

    <script>
      const canvas = document.getElementById("wheelCanvas");
      const ctx = canvas.getContext("2d");
      const spinBtn = document.getElementById("spinBtn");
      const resultDiv = document.getElementById("result");
      const codeInput = document.getElementById("couponCode");

      // ========== è«‹ç¢ºèªé€™è£¡æ˜¯ç”¨ã€Œæ–°ç‰ˆæœ¬éƒ¨ç½²ã€å¾Œçš„ç¶²å€ ==========
      const API_URL =
        "https://script.google.com/macros/s/AKfycbzZ_3oGG1j9DnyigrXJfYLNqTflmjtkC_UeJr382yvTxahTKF3ofe2CAkhFe1mJ-f-C/exec";
      // ======================================================

      // è¦–è¦ºçé … (ä¸è®Šï¼Œåƒ…ä¾›é¡¯ç¤º)
      const visualSegments = [
        "ä¸€ç:è‰è“ä¸€ç›’",
        "æ™®ç:æŠ˜åƒ¹åˆ¸",
        "äºŒç:è‰è“å‡ä¹¾",
        "æ™®ç:æŠ˜åƒ¹åˆ¸",
        "ä¸‰ç:å†°æ·‡æ·‹",
        "æ™®ç:æŠ˜åƒ¹åˆ¸",
        "æ™®ç:æŠ˜åƒ¹åˆ¸",
        "æ™®ç:æŠ˜åƒ¹åˆ¸",
      ];

      const colors = [
        "#FFEBEE",
        "#FFCDD2",
        "#EF9A9A",
        "#E57373",
        "#EF5350",
        "#FFCDD2",
        "#FFEBEE",
        "#FFCDD2",
      ];
      let currentRotation = 0;

      // ç¹ªåœ–å‡½å¼ (ä¸è®Š)
      function drawWheel() {
        const arc = (Math.PI * 2) / visualSegments.length;
        for (let i = 0; i < visualSegments.length; i++) {
          ctx.beginPath();
          ctx.fillStyle = colors[i];
          ctx.moveTo(250, 250);
          ctx.arc(250, 250, 250, i * arc - arc / 2, (i + 1) * arc - arc / 2);
          ctx.fill();
          ctx.save();
          ctx.translate(250, 250);
          ctx.rotate(i * arc);
          ctx.textAlign = "right";
          ctx.fillStyle = "#B71C1C";
          ctx.font = "bold 24px Microsoft JhengHei";
          ctx.fillText(visualSegments[i].split(":")[0], 220, 10);
          ctx.restore();
        }
      }
      drawWheel();

      // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¾ç…§ç­‰ç´šè¨ˆç®—æ©Ÿç‡ â˜…â˜…â˜…
      function getPrize(level) {
        const rand = Math.random() * 100;
        let p1, p2, p3;

        // åˆ¤æ–·ç­‰ç´šï¼Œè¨­å®šæ©Ÿç‡é–¥å€¼
        // LV1: 1ç3%, 2ç5%, 3ç7% (ç´¯è¨ˆ: 3, 8, 15)
        // LV2: 1ç1.5%, 2ç2.5%, 3ç3.5% (ç´¯è¨ˆ: 1.5, 4, 7.5)
        // LV3: 1ç0.5%, 2ç1.5%, 3ç2% (ç´¯è¨ˆ: 0.5, 2, 4)

        if (level.includes("LV3")) {
          p1 = 0.5;
          p2 = 1.5;
          p3 = 2.0;
        } else if (level.includes("LV2")) {
          p1 = 1.5;
          p2 = 2.5;
          p3 = 3.5;
        } else {
          // é è¨­ LV1
          p1 = 3.0;
          p2 = 5.0;
          p3 = 7.0;
        }

        console.log(
          `ç›®å‰ç­‰ç´š: ${level}, æ©Ÿç‡è¨­å®š: ä¸€ç<${p1}, äºŒç<${p1 + p2}, ä¸‰ç<${
            p1 + p2 + p3
          }`
        );

        // åˆ¤æ–·ä¸­ç (ä½¿ç”¨ç´¯è¨ˆæ©Ÿç‡)
        if (rand < p1) return { name: "ä¸€çï¼šè‰è“ä¸€ç›’", index: 0 };
        if (rand < p1 + p2) return { name: "äºŒçï¼šè‰è“å‡ä¹¾ä¸€ç½", index: 2 };
        if (rand < p1 + p2 + p3)
          return { name: "ä¸‰çï¼šè‰è“å†°æ·‡æ·‹ä¸€æ¯", index: 4 };

        // æ²’ä¸­å¤§çï¼Œéš¨æ©Ÿçµ¦æ™®ç
        const normalIndices = [1, 3, 5, 6, 7];
        const randomNormal =
          normalIndices[Math.floor(Math.random() * normalIndices.length)];
        return { name: "æ™®çï¼šè‰è“æŠ˜åƒ¹åˆ¸30å…ƒ", index: randomNormal };
      }

      function startGame() {
        const code = codeInput.value.trim();

        if (!code) {
          alert("è«‹è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼ï¼");
          return;
        }

        spinBtn.disabled = true;
        spinBtn.innerText = "é©—è­‰ä¸­...";
        resultDiv.innerText = "æ­£åœ¨ç¢ºèªä»£ç¢¼èˆ‡ç­‰ç´š...";

        fetch(API_URL, {
          method: "POST",
          body: JSON.stringify({ code: code }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "success") {
              // â˜… é©—è­‰æˆåŠŸï¼Œå‚³å…¥å¾Œç«¯å›å‚³çš„ level (ä¾‹å¦‚ "LV2")
              performSpin(data.level);
            } else if (data.status === "used") {
              alert("é€™çµ„ä»£ç¢¼å·²ç¶“ä½¿ç”¨éäº†å–”ï¼");
              resetButton();
            } else {
              alert("æ‰¾ä¸åˆ°é€™çµ„ä»£ç¢¼ï¼Œè«‹ç¢ºèªæ˜¯å¦è¼¸å…¥æ­£ç¢ºã€‚");
              resetButton();
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            resetButton();
          });
      }

      function resetButton() {
        spinBtn.disabled = false;
        spinBtn.innerText = "é–‹å§‹æŠ½ç";
        resultDiv.innerText = "";
      }

      function performSpin(level) {
        spinBtn.innerText = "æŠ½çä¸­...";

        // â˜… å°‡ç­‰ç´šå‚³å…¥æ©Ÿç‡è¨ˆç®—å‡½å¼
        const prize = getPrize(level);

        const segmentAngle = 360 / visualSegments.length;
        const rotateAmount = 360 * 5 + (360 - prize.index * segmentAngle) - 90;
        const randomOffset = Math.floor(Math.random() * 20) - 10;

        currentRotation += rotateAmount + randomOffset;
        canvas.style.transform = `rotate(${currentRotation}deg)`;

        setTimeout(() => {
          resultDiv.innerText = `æ­å–œç²å¾—ï¼š${prize.name}`;
          resultDiv.style.color = "#d32f2f";
          alert(`æ­å–œï¼ä½ æŠ½ä¸­äº† ${prize.name}ï¼\n(ç­‰ç´š: ${level})`);
          spinBtn.disabled = false;
          spinBtn.innerText = "é–‹å§‹æŠ½ç";
          codeInput.value = "";
        }, 4000);
      }
    </script>
  </body>
</html>
