<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰è“åœ’å¹¸é‹è½‰ç›¤</title>
    <style>
        /* ... ä¿ç•™åŸæœ¬çš„ CSS ... */
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #fff0f5; display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        h1 { color: #d32f2f; margin-bottom: 10px; }
        .game-container { position: relative; width: 300px; height: 300px; margin-bottom: 20px; }
        canvas { width: 100%; height: 100%; border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 4s cubic-bezier(0.25, 0.1, 0.25, 1); }
        .pointer { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 15px solid transparent; border-right: 15px solid transparent; border-top: 30px solid #d32f2f; z-index: 10; }
        .controls { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; width: 80%; max-width: 320px; }
        input { padding: 10px; border: 2px solid #ffb6c1; border-radius: 5px; font-size: 16px; width: 70%; text-align: center; outline: none; }
        button { margin-top: 10px; padding: 10px 20px; background-color: #d32f2f; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; }
        button:disabled { background-color: #ccc; }
        
        /* æ–°å¢ï¼šé ˜çä»£ç¢¼å½ˆå‡ºè¦–çª—æ¨£å¼ */
        .modal {
            display: none; /* é è¨­éš±è— */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center; justify-content: center; z-index: 100;
        }
        .modal-content {
            background-color: white; padding: 30px; border-radius: 15px; text-align: center; width: 80%; max-width: 300px;
            border: 5px solid #ffb6c1;
        }
        .prize-code {
            font-size: 24px; font-weight: bold; color: #d32f2f; letter-spacing: 2px;
            margin: 15px 0; background: #eee; padding: 10px; border-radius: 5px; word-break: break-all;
        }
        .copy-btn {
            background-color: #4CAF50; margin-top: 5px;
        }
    </style>
</head>
<body>

    <h1>ğŸ“ è‰è“å¹¸é‹è½‰ç›¤</h1>
    <div class="game-container">
        <div class="pointer"></div>
        <canvas id="wheelCanvas" width="500" height="500"></canvas>
    </div>

    <div class="controls">
        <input type="text" id="couponCode" placeholder="è«‹è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼">
        <br>
        <button id="spinBtn" onclick="verifyAndSpin()">é–‹å§‹æŠ½ç</button>
        <div id="result" style="margin-top:10px; height:20px;"></div>
    </div>

    <div id="prizeModal" class="modal">
        <div class="modal-content">
            <h2 id="modalPrizeTitle" style="color:#d32f2f">æ­å–œç²ç</h2>
            <p>è«‹å‡ºç¤ºæ­¤ä»£ç¢¼çµ¦å·¥ä½œäººå“¡ï¼š</p>
            <div id="displayCode" class="prize-code">LOADING...</div>
            <button class="copy-btn" onclick="copyCode()">ğŸ“‹ è¤‡è£½ä»£ç¢¼</button>
            <button onclick="closeModal()" style="background-color:#666; margin-top:10px">é—œé–‰</button>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('wheelCanvas');
        const ctx = canvas.getContext('2d');
        const spinBtn = document.getElementById('spinBtn');
        const resultDiv = document.getElementById('result');
        const codeInput = document.getElementById('couponCode');
        const modal = document.getElementById('prizeModal');
        const displayCode = document.getElementById('displayCode');
        
        // â˜…â˜…â˜… è«‹æ›¿æ›æˆæ‚¨æœ€æ–°çš„éƒ¨ç½²ç¶²å€ â˜…â˜…â˜…
        const API_URL = "https://script.google.com/macros/s/AKfycbz0eUq1m4vWgTLNp4HgVZ11RM4_7BkgAhzolgpUaAcrwdP62LJIcmynbJO6EAT_Gc4K/exec";

        const visualSegments = [
            "ä¸€ç:è‰è“ä¸€ç›’", "æ™®ç:æŠ˜åƒ¹åˆ¸", "äºŒç:è‰è“å‡ä¹¾", "æ™®ç:æŠ˜åƒ¹åˆ¸", 
            "ä¸‰ç:å†°æ·‡æ·‹", "æ™®ç:æŠ˜åƒ¹åˆ¸", "æ™®ç:æŠ˜åƒ¹åˆ¸", "æ™®ç:æŠ˜åƒ¹åˆ¸"
        ];
        const colors = ["#FFEBEE", "#FFCDD2", "#EF9A9A", "#E57373", "#EF5350", "#FFCDD2", "#FFEBEE", "#FFCDD2"];
        let currentRotation = 0;

        // ç¹ªè£½è½‰ç›¤ (èˆ‡ä¹‹å‰ç›¸åŒ)
        function drawWheel() {
            const arc = Math.PI * 2 / visualSegments.length;
            for (let i = 0; i < visualSegments.length; i++) {
                ctx.beginPath();
                ctx.fillStyle = colors[i];
                ctx.moveTo(250, 250);
                ctx.arc(250, 250, 250, i * arc - (arc/2), (i + 1) * arc - (arc/2));
                ctx.fill();
                ctx.save();
                ctx.translate(250, 250);
                ctx.rotate(i * arc);
                ctx.textAlign = "right";
                ctx.fillStyle = "#B71C1C";
                ctx.font = "bold 24px Microsoft JhengHei";
                ctx.fillText(visualSegments[i].split(":")[0], 220, 10);
                ctx.restore();
            }
        }
        drawWheel();

        // æ©Ÿç‡é‚è¼¯ (èˆ‡ä¹‹å‰ç›¸åŒ)
        function getPrize(level) {
            const rand = Math.random() * 100;
            let p1, p2, p3;
            if (level.includes("LV3")) { p1=0.5; p2=1.5; p3=2.0; } 
            else if (level.includes("LV2")) { p1=1.5; p2=2.5; p3=3.5; } 
            else { p1=3.0; p2=5.0; p3=7.0; }

            if (rand < p1) return { name: "ä¸€çï¼šè‰è“ä¸€ç›’", index: 0 };
            if (rand < (p1+p2)) return { name: "äºŒçï¼šè‰è“å‡ä¹¾ä¸€ç½", index: 2 };
            if (rand < (p1+p2+p3)) return { name: "ä¸‰çï¼šè‰è“å†°æ·‡æ·‹ä¸€æ¯", index: 4 };
            const normalIndices = [1, 3, 5, 6, 7];
            return { name: "æ™®çï¼šè‰è“æŠ˜åƒ¹åˆ¸30å…ƒ", index: normalIndices[Math.floor(Math.random() * normalIndices.length)] };
        }

        // æ­¥é©Ÿ 1: é©—è­‰ä»£ç¢¼
        function verifyAndSpin() {
            const code = codeInput.value.trim();
            if (!code) { alert("è«‹è¼¸å…¥å„ªæƒ åˆ¸ä»£ç¢¼ï¼"); return; }

            spinBtn.disabled = true;
            spinBtn.innerText = "é©—è­‰ä¸­...";
            resultDiv.innerText = "æ­£åœ¨ç¢ºèªä»£ç¢¼...";

            // å‚³é€ action: 'validate'
            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "validate", code: code })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    performSpin(data.level, code);
                } else {
                    alert(data.message || "ä»£ç¢¼ç„¡æ•ˆæˆ–å·²ä½¿ç”¨");
                    resetButton();
                }
            })
            .catch(err => { console.error(err); alert("é€£ç·šéŒ¯èª¤"); resetButton(); });
        }

        function resetButton() {
            spinBtn.disabled = false;
            spinBtn.innerText = "é–‹å§‹æŠ½ç";
            resultDiv.innerText = "";
        }

        // æ­¥é©Ÿ 2: è½‰å‹•è½‰ç›¤ -> åœæ­¢å¾Œç´€éŒ„è³‡æ–™
        function performSpin(level, validCode) {
            spinBtn.innerText = "æŠ½çä¸­...";
            const prize = getPrize(level);
            
            const segmentAngle = 360 / visualSegments.length;
            const rotateAmount = 360 * 5 + (360 - (prize.index * segmentAngle)) - 90; 
            const randomOffset = Math.floor(Math.random() * 20) - 10; 
            currentRotation += rotateAmount + randomOffset;
            canvas.style.transform = `rotate(${currentRotation}deg)`;

            // ç­‰å¾…è½‰ç›¤åœä¸‹ (4ç§’)
            setTimeout(() => {
                logPrizeAndShowCode(validCode, prize.name);
            }, 4000);
        }

        // æ­¥é©Ÿ 3: å›å‚³çµæœä¸¦é¡¯ç¤ºé ˜çç¢¼
        function logPrizeAndShowCode(code, prizeName) {
            resultDiv.innerText = `ä¸­çï¼š${prizeName} (ç”¢ç”Ÿä»£ç¢¼ä¸­...)`;
            
            // å‚³é€ action: 'log'
            fetch(API_URL, {
                method: "POST",
                body: JSON.stringify({ action: "log", code: code, prizeName: prizeName })
            })
            .then(response => response.json())
            .then(data => {
                // é¡¯ç¤ºå½ˆå‡ºè¦–çª—
                document.getElementById('modalPrizeTitle').innerText = prizeName;
                displayCode.innerText = data.secureCode;
                modal.style.display = "flex";
                
                resetButton();
                codeInput.value = ""; // æ¸…ç©ºè¼¸å…¥æ¡†
            })
            .catch(err => {
                alert("ç²çç´€éŒ„å¯«å…¥å¤±æ•—ï¼Œè«‹æˆªåœ–æ­¤ç•«é¢è¯ç¹«å·¥ä½œäººå“¡ã€‚\n" + prizeName);
            });
        }

        // è¤‡è£½åŠŸèƒ½
        function copyCode() {
            const text = displayCode.innerText;
            navigator.clipboard.writeText(text).then(() => {
                alert("ä»£ç¢¼å·²è¤‡è£½ï¼");
            }).catch(err => {
                alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•é•·æŒ‰è¤‡è£½ã€‚");
            });
        }

        function closeModal() {
            modal.style.display = "none";
        }
    </script>
</body>
</html>